name: Deploy SembakoBayi

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Navigate to the project directory (ADJUST THIS PATH)
            cd /var/www/bryan/SembakoBayi

            git fetch origin main
            # Pull latest changes from Git
            git pull origin main

            # Stop and remove existing containers
            docker compose down

            # Build and start services (sb_app_new, db)
            docker compose up -d --build --remove-orphans

            # Run Prisma migrations (IF USING PRISMA)
            docker compose exec sb_app_new pnpm prisma migrate deploy

            # Clean up old images
            docker image prune -f